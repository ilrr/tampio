document.onscroll=()=>{let e=document.elementsFromPoint(20,20).find(e=>e.className=="account");let t=document.querySelector("#general-ledger-header .account-info");if(t){t.innerHTML=e?e.querySelector(".account-info").innerHTML:"";t.parentElement.style.backgroundColor=e?getComputedStyle(e.querySelector(".header")).backgroundColor.replace("rgba(0, 0, 0, 0)",""):""}};document.addEventListener("click",e=>{const t=location.hash.slice(1);if(t){const n=document.getElementById(t);if(n&&!n.contains(e.target)){location.hash="🫶"}}if(e.target.tagName=="H2"){e.target.parentElement.classList.toggle("hidden")}else if(e.target.classList.contains("name")&&e.target.parentElement.parentElement.classList.contains("header")){const t=e.target.parentElement.parentElement.parentElement;if(t.classList.contains("account")&&!t.classList.contains("leaf")){t.classList.toggle("collapse")}}});document.addEventListener("input",e=>{if(e.target.parentElement.classList.contains("budget"))updateBAccount(e.target)});window.onload=()=>{let e=0;document.querySelectorAll(".budget input").forEach(t=>{const n=e;t.id=`input-${n}`;t.addEventListener("keydown",e=>{if(e.code=="ArrowDown"||e.code=="KeyJ"||e.code=="KeyS"||e.code=="Enter"||e.code=="NumpadEnter"){e.preventDefault();document.getElementById(`input-${n+2}`).focus()}else if(e.code=="ArrowUp"||e.code=="KeyK"||e.code=="KeyW"){e.preventDefault();document.getElementById(`input-${n-2}`).focus()}else if(e.code=="KeyL"||e.code=="KeyD"||t.value==""&&e.code=="ArrowRight"&&n%2==0){e.preventDefault();document.getElementById(`input-${n+1}`).focus()}else if(e.code=="KeyH"||e.code=="KeyA"||t.value==""&&e.code=="ArrowLeft"&&n%2==1){e.preventDefault();document.getElementById(`input-${n-1}`).focus()}else if(e.code=="KeyX"){e.preventDefault();t.value="";updateBAccount(t)}});e+=1;if(t.value!=""){updateBAccount(t)}})};const updateBAccount=e=>{if(e.value.match(/^\d*[.,]?\d{0,2}$/)){e.classList.remove("bad")}else{e.classList.add("bad")}const t=e.parentElement.parentElement;const n=Number(t.querySelector(".debit input").value.replace(",","."));const o=Number(t.querySelector(".credit input").value.replace(",","."));t.querySelector(".budget.sum").innerText=n||o?(o-n).toFixed(2).replace(".",","):"";t.parentElement.setAttribute("data-rec-credit",o);t.parentElement.setAttribute("data-rec-debit",n);const c=t.parentElement;if(c.classList.contains("account")){updateBAccountFooter(c)}};const updateBAccountFooter=e=>{let t=e.querySelector("& > .header:has(input)");let n=0;let o=0;if(t){o=Number(t.querySelector(".debit input").value.replace(",","."));n=Number(t.querySelector(".credit input").value.replace(",","."))}for(child of e.children){n+=Number(child.getAttribute("data-rec-credit"));o+=Number(child.getAttribute("data-rec-debit"))}e.setAttribute("data-rec-credit",n);e.setAttribute("data-rec-debit",o);const c=e.querySelector("& > .footer");if(c){c.querySelector(".budget.credit").innerText=n.toFixed(2).replace(".",",");c.querySelector(".budget.debit").innerText=o.toFixed(2).replace(".",",");c.querySelector(".budget.sum").innerText=(n-o).toFixed(2).replace(".",",")}const r=e.parentElement;if(r.classList.contains("account")){updateBAccountFooter(r)}};const displayOutput=()=>{const e=document.getElementById("budget-output");e.value=`§ TALOUSARVIO\n${generateOutput()}`;document.getElementById("budget-output-container").classList.toggle("hidden")};const saveBudget=async()=>{let e=document.getElementById("budget-fy-title").value;const t="\"'»”’›«‘‛“‟‹⸂⸄⸉⸌⸜⸠⸃⸅⸊⸍⸝⸡";for(let n of t){if(!e.includes(n)){e=`lyhenne = ${n}${e}${n}`;break}}const n=await fetch("/save_budget",{method:"POST",body:`§ TALOUSARVIO\n${generateOutput()}\n\n§ TIEDOT\n${e}`});let o=document.createElement("div");if(n.ok){o.innerText="Talousarvio tallennettu";o.style="position:fixed;top:0;right:0;background:lightgreen;"}else{o.innerText="Talousarvion tallennus epäonnistui";o.style="position:fixed;top:0;right:0;background:red;"}document.body.appendChild(o);setTimeout(()=>{o.remove()},2500)};const generateOutput=()=>{let e="";for(let t of document.querySelectorAll(".header[id]")){const n=t.id.split("-")[1];const o=t.querySelector("& > .budget.debit input").value.trim();const c=t.querySelector("& > .budget.credit input").value.trim();let r=[];if(o)r.push(o+" DR");if(c)r.push(c+" CR");if(r.length){e+=`${e.length?"\n":""}${n}: ${r.join("; ")}`}}return e};const hideOutput=()=>{document.getElementById("budget-output-container").classList.toggle("hidden")};
